<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title id="pageTitle">Quiz de Estudo</title>
<meta name="description" content="Flashcards + Teste com distratores plausíveis" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --card-2:#0b1224; --fg:#e5e7eb; --muted:#94a3b8;
    --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --link:#38bdf8; --border:#1f2937;
    --ok:#10b981; --bad:#ef4444; --btn:#1e293b; --btn-hover:#243447;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f8fafc; --card:#ffffff; --card-2:#f1f5f9; --fg:#0f172a; --muted:#475569; --border:#e2e8f0; --btn:#e2e8f0; --btn-hover:#cbd5e1; }
  }
  /* Kid-Friendly Theme */
  body[data-theme="kids"]{
    --bg:#fff8f0; --card:#ffffff; --card-2:#fef3e7; --fg:#2c3e50; --muted:#7f8c8d;
    --accent:#27ae60; --warn:#f39c12; --danger:#e74c3c; --link:#3498db; --border:#e8dacc;
    --ok:#2ecc71; --bad:#e74c3c; --btn:#ecf0f1; --btn-hover:#dfe6e9;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--fg); font:18px/1.6 'Nunito',system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"; transition:background 0.3s, color 0.3s }
  header{ position:sticky; top:0; z-index:5; backdrop-filter:saturate(180%) blur(8px);
    background:linear-gradient(to bottom, rgba(2,6,23,.9), rgba(2,6,23,.6)); border-bottom:1px solid var(--border) }
  .wrap{ max-width:1100px; margin:0 auto; padding:1rem }
  h1{ margin:.2rem 0 0; font-size:clamp(1.1rem,2.2vw,1.5rem) }
  .subtitle{ color:var(--muted); font-size:.95rem }
  nav{ margin-top:.7rem; display:flex; gap:.5rem; flex-wrap:wrap }
  nav button{ background:var(--btn); color:var(--fg); border:1px solid var(--border); padding:.5rem .8rem; border-radius:.6rem; cursor:pointer }
  nav button.active{ outline:2px solid var(--link) }
  main{ padding:1rem 0 2rem }
  .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:1rem; align-items:start }
  @media (max-width: 1000px){ .grid{ grid-template-columns:1fr } }
  .centered{ max-width:900px; margin:0 auto }
  @media (max-width: 768px){ 
    .centered{ max-width:100% }
    .flashcard{ padding:1.2rem; min-height:280px }
    .flash-q{ font-size:1.2rem }
    .flash-a{ font-size:1rem; padding:.8rem }
    .two-col{ grid-template-columns:1fr; gap:.6rem }
    .two-col>.btn{ padding:.7rem .9rem; font-size:.95rem }
    .panel{ padding:.8rem }
    .toolbar{ gap:.4rem }
  }
  .panel{ background:var(--card); border:1px solid var(--border); border-radius:.9rem; padding:1rem }
  .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom:.6rem }
  .toolbar select, .toolbar input[type="number"]{ background:var(--card-2); color:var(--fg); border:1px solid var(--border); padding:.45rem .6rem; border-radius:.6rem }
  .btn{ background:var(--btn); color:var(--fg); border:2px solid var(--border); padding:.9rem 1.2rem; border-radius:1rem; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; font-weight:600; font-size:1.05rem; box-shadow:0 2px 8px rgba(0,0,0,0.1) }
  .btn:hover{ background:var(--btn-hover); transform: translateY(-2px) scale(1.02); box-shadow:0 6px 16px rgba(0,0,0,0.2) }
  .btn:active{ transform: translateY(0) scale(0.98) }
  .btn.primary{ background:linear-gradient(135deg,#2563eb,#06b6d4); border:none; color:white }
  .btn.good{ background:linear-gradient(135deg,#16a34a,#22c55e); border:none; color:white }
  .btn.bad{ background:linear-gradient(135deg,#ef4444,#f97316); border:none; color:white }
  .btn.warn{ background:linear-gradient(135deg,#f59e0b,#f97316); border:none; color:white }
  .muted{ color:var(--muted) } .small{ font-size:.9rem }
  .pill{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .5rem; border:1px solid var(--border); border-radius:999px; background:var(--card-2); color:var(--muted); font-size:.8rem }
  .progress{ height:10px; background:var(--card-2); border:1px solid var(--border); border-radius:999px; overflow:hidden }
  .bar{ height:100%; background:linear-gradient(90deg,#06b6d4,#22c55e) }
  .flashcard{ background: radial-gradient(1200px 600px at 50% -200px, rgba(59,130,246,.25), transparent 60%), var(--card);
    border:2px solid var(--border); border-radius:1.5rem; padding:2.5rem; min-height:360px; display:flex; flex-direction:column; justify-content:space-between; box-shadow:0 4px 12px rgba(0,0,0,0.1) }
  .flash-q{ font-size:1.65rem; line-height:1.6; text-align:center; font-weight:600 }
  .flash-a{ margin-top:1.2rem; padding:1.4rem; border-radius:1rem; border:2px dashed var(--border); background:var(--card-2); font-size:1.35rem; line-height:1.6; text-align:center; font-weight:500 }
  .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:.8rem }
  .two-col>.btn{ width:100%; padding:.8rem 1rem; font-size:1rem }
  .stack{ display:flex; flex-direction:column; gap:.5rem }
  .list{ display:flex; flex-direction:column; gap:.5rem; max-height:420px; overflow:auto }
  .item{ border:1px solid var(--border); border-radius:.6rem; padding:.6rem .7rem; display:flex; justify-content:space-between; align-items:center; gap:.6rem; background:var(--card-2) }
  .foot{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; justify-content:space-between; margin-top:1rem; padding-top:1rem; border-top:1px dashed var(--border); color:var(--muted) }
  .score{ font-weight:700 }
  .hidden{ display:none !important }
  .tag{ font-size:.78rem; padding:.15rem .45rem; border-radius:.45rem; border:1px solid var(--border); background:var(--card-2); color:var(--muted) }
  details[open] summary{ margin-bottom:.5rem }
  summary{ cursor:pointer }
  .loading{ text-align:center; padding:2rem; font-size:1.2rem }
  .error{ background:var(--danger); color:white; padding:1rem; border-radius:.6rem; margin:1rem 0 }

  /* Animations */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }
  @keyframes celebrate {
    0% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.15) rotate(-5deg); }
    50% { transform: scale(1.1) rotate(5deg); }
    75% { transform: scale(1.15) rotate(-3deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .shake { animation: shake 0.5s; }
  .bounce { animation: bounce 0.6s; }
  .pulse { animation: pulse 0.4s; }
  .celebrate { animation: celebrate 0.6s; }
  .slide-in { animation: slideIn 0.4s ease-out; }

  /* Emoji reaction overlay */
  .emoji-reaction {
    position: fixed;
    font-size: 3rem;
    pointer-events: none;
    z-index: 1000;
    animation: emojiFloat 1.5s ease-out forwards;
  }
  @keyframes emojiFloat {
    0% { transform: translateY(0) scale(0.5); opacity: 1; }
    100% { transform: translateY(-150px) scale(1.2); opacity: 0; }
  }

  /* Enhanced progress bar animation */
  .bar {
    transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
  }

  /* Theme toggle button */
  .theme-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .theme-toggle:hover {
    transform: scale(1.1) rotate(10deg);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }

  /* Sound toggle button */
  .sound-toggle {
    position: fixed;
    bottom: 20px;
    right: 90px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f093fb, #f5576c);
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .sound-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }
  .sound-toggle.muted {
    opacity: 0.5;
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 id="headerTitle">Carregando...</h1>
    <div class="subtitle" id="headerSubtitle"></div>
    <nav aria-label="Modos">
      <button class="tabbtn active" data-tab="flash">Cartões</button>
      <button class="tabbtn" data-tab="quiz">Teste Rápido</button>
      <button class="tabbtn" data-tab="vf">Verdadeiro/Falso</button>
      <button class="tabbtn" data-tab="painel">Painel</button>
      <button class="btn" onclick="window.location.href='index.html'" style="margin-left: auto; background: var(--btn); color: var(--fg); border: 1px solid var(--border); padding: .5rem .8rem; border-radius: .6rem; cursor: pointer;">← Voltar à Seleção</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <div id="loadingScreen" class="loading">
    <div>Carregando conteúdo...</div>
    <div class="small muted" style="margin-top:.5rem">A carregar o ficheiro JSON</div>
  </div>

  <div id="errorScreen" class="hidden">
    <div class="error">
      <strong>Erro ao carregar conteúdo</strong>
      <div class="small" id="errorMessage"></div>
    </div>
  </div>

  <!-- CARTÕES -->
  <section id="flash" class="tab hidden">
    <div class="panel centered">
      <div class="toolbar">
        <label> Tema:
          <select id="temaSelect"></select>
        </label>
        <span class="pill" id="duePill">Devidos hoje: <strong id="dueCount">0</strong></span>
        <span class="pill">Domínio: <strong id="masteryPct">0%</strong></span>
        <span class="pill">Sessão: <strong id="sessStats">0/0</strong></span>
        <span class="pill">⏱ <span id="timer">00:00</span></span>
        <span class="small muted">Atalhos: <span class="tag">Espaço</span> Revelar • <span class="tag">A</span> Acertei • <span class="tag">E</span> Errei</span>
      </div>

      <div class="flashcard" aria-live="polite">
        <div>
          <div class="small muted" id="fcMeta"></div>
          <div class="flash-q" id="fcQ">Carregar em "Novo cartão".</div>
          <div class="flash-a hidden" id="fcA"></div>
        </div>
        <div class="two-col" style="margin-top:1rem">
          <button id="revealBtn" class="btn primary"><strong>Revelar</strong> <span class="tag" style="font-size:.75rem;margin-left:.3rem">Espaço</span></button>
          <button id="nextBtn" class="btn">Novo cartão</button>
        </div>
        <div class="two-col" style="margin-top:.8rem">
          <button id="wrongBtn" class="btn bad" disabled><strong>Errei</strong> <span class="tag" style="font-size:.75rem;margin-left:.3rem">E</span></button>
          <button id="rightBtn" class="btn good" disabled><strong>Acertei</strong> <span class="tag" style="font-size:.75rem;margin-left:.3rem">A</span></button>
        </div>
      </div>
      <div class="foot small">
        <div>Revisão espaçada: <span class="muted">Leitner (caixas 1→3: ~1/3/7 dias)</span></div>
        <div class="muted">Progresso guarda em <code>localStorage</code>.</div>
      </div>

      <details style="margin-top:1.5rem">
        <summary class="muted">📊 Resumo e Progresso</summary>
        <div class="stack" style="margin-top:.8rem">
          <div>
            <h4 style="margin:0 0 .4rem">Progresso Global</h4>
            <div class="progress"><div id="globalBar" class="bar" style="width:0%"></div></div>
          </div>
          <div>
            <h4 style="margin:0 0 .4rem">Progresso por Tema</h4>
            <div class="list" id="temaList"></div>
          </div>
        </div>
      </details>

      <details style="margin-top:.8rem">
        <summary class="muted">💾 Exportar / Importar / Repor</summary>
        <div class="stack" style="margin-top:.8rem">
          <button class="btn" id="exportBtn">Exportar progresso (JSON)</button>
          <input type="file" id="importFile" accept="application/json" />
          <button class="btn warn" id="resetBtn">Repor tudo</button>
        </div>
      </details>
    </div>
  </section>

  <!-- TESTE RÁPIDO -->
  <section id="quiz" class="grid tab hidden">
    <div class="panel">
      <div class="toolbar">
        <label> Nº de perguntas:
          <input type="number" id="quizN" min="5" max="25" value="10" />
        </label>
        <label> Tema:
          <select id="quizTema"></select>
        </label>
        <label> Nível:
          <select id="quizLvl">
            <option value="medio" selected>Médio</option>
            <option value="dificil">Difícil</option>
            <option value="facil">Fácil</option>
          </select>
        </label>
        <button class="btn primary" id="startQuiz">Começar teste</button>
        <span class="pill">Pontuação: <strong id="quizScore">0</strong></span>
        <span class="small muted">Clique nas opções para responder</span>
      </div>
      <div id="quizBox" class="stack"></div>
    </div>
    <aside class="panel">
      <h3 style="margin:0 0 .3rem">Histórico</h3>
      <div id="quizHistory" class="stack small"></div>
    </aside>
  </section>

  <!-- VERDADEIRO / FALSO -->
  <section id="vf" class="grid tab hidden">
    <div class="panel">
      <div class="toolbar">
        <button class="btn primary" id="vfNew">Nova afirmação <span class="tag" style="font-size:.75rem;margin-left:.3rem">Espaço</span></button>
        <span class="pill">Corretas na sessão: <strong id="vfSess">0</strong></span>
        <span class="small muted">Atalhos: <span class="tag">V</span> Verdadeiro • <span class="tag">F</span> Falso • <span class="tag">Espaço</span> Nova</span>
      </div>
      <div class="flashcard">
        <div>
          <div class="small muted" id="vfMeta"></div>
          <div class="flash-q" id="vfText">Clique em "Nova afirmação".</div>
          <div class="flash-a hidden" id="vfExp"></div>
        </div>
        <div class="two-col" style="margin-top:1rem">
          <button class="btn bad" id="vfF">Falso <span class="tag" style="font-size:.75rem;margin-left:.3rem">F</span></button>
          <button class="btn good" id="vfV">Verdadeiro <span class="tag" style="font-size:.75rem;margin-left:.3rem">V</span></button>
        </div>
      </div>
    </div>
    <aside class="panel">
      <h3 style="margin:0 0 .3rem">Dica</h3>
      <p class="muted small">As opções foram escritas para "enganar" de forma justa. Lê com atenção palavras‑chave e compara com os cartões.</p>
    </aside>
  </section>

  <!-- PAINEL -->
  <section id="painel" class="tab hidden">
    <div class="panel">
      <h3 style="margin-top:0">Painel de Progresso</h3>
      <div class="grid" style="grid-template-columns: .9fr 1.1fr">
        <div class="stack">
          <div class="item"><span>Total de cartões</span><strong id="pTotal">0</strong></div>
          <div class="item"><span>Vistos (alguma vez)</span><strong id="pVistos">0</strong></div>
          <div class="item"><span>Domínio (caixa 3)</span><strong id="pDom">0</strong></div>
          <div class="item"><span>Devidos hoje</span><strong id="pDueToday">0</strong></div>
          <div class="item"><span>Tempo total de estudo</span><strong id="pTime">0 min</strong></div>
          <div class="item"><span>Streak diário (≥10 cartões)</span><strong id="pStreak">0 🔥</strong></div>
        </div>
        <div class="panel" style="background:var(--card-2)">
          <h4 style="margin-top:0">Revisões próximas (14 dias)</h4>
          <div id="calendar" class="stack small"></div>
        </div>
      </div>
    </div>
  </section>

</main>

<footer class="wrap small muted" style="padding-bottom:2rem">
  <div id="footerText">Para uso educativo.</div>
</footer>

<!-- Theme Toggle Button -->
<button class="theme-toggle" id="themeToggle" title="Alternar tema para crianças" aria-label="Alternar tema">🎨</button>

<!-- Sound Toggle Button -->
<button class="sound-toggle" id="soundToggle" title="Ativar/desativar sons" aria-label="Ativar/desativar sons">🔊</button>

<script>
/* =======================================================
   QUIZ ENGINE - Generic content loader
   ======================================================= */

// Global variables for content
let CARDS = [];
let DIST = {};
let VF = [];
let METADATA = {};
let CONTENT_KEY = ""; // Will be set based on loaded content

/* =======================================================
   Content Loading
   ======================================================= */
async function loadContent(jsonPath) {
  try {
    let data;
    
    // Check if loading from localStorage (uploaded file)
    if (jsonPath.startsWith('from_storage:')) {
      const storageKey = jsonPath.replace('from_storage:', '');
      const storedData = localStorage.getItem(storageKey);
      if (!storedData) {
        throw new Error('Dados do ficheiro não encontrados no localStorage');
      }
      data = JSON.parse(storedData);
    } else {
      // Load from file
      const response = await fetch(jsonPath);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      data = await response.json();
    }
    
    // Validate required fields
    if (!data.metadata || !data.cards || !data.distractors || !data.trueFalse) {
      throw new Error("JSON inválido: faltam campos obrigatórios (metadata, cards, distractors, trueFalse)");
    }
    
    // Load content into global variables
    METADATA = data.metadata;
    CARDS = data.cards;
    DIST = data.distractors;
    VF = data.trueFalse;
    
    // Set content-specific localStorage key
    CONTENT_KEY = `QUIZ_${METADATA.unit}_${METADATA.version}`;
    
    // Update page metadata
    document.title = `${METADATA.title} — ${METADATA.subtitle}`;
    document.getElementById('pageTitle').textContent = document.title;
    document.getElementById('headerTitle').innerHTML = `${METADATA.title} <span class="muted">${METADATA.subtitle}</span>`;
    document.getElementById('headerSubtitle').innerHTML = METADATA.description || "";
    document.getElementById('footerText').innerHTML = METADATA.footer || "Para uso educativo.";
    
    // Hide loading screen
    document.getElementById('loadingScreen').classList.add('hidden');
    
    // Initialize the quiz
    initializeQuiz();
    
    return true;
  } catch (error) {
    console.error("Erro ao carregar conteúdo:", error);
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('errorScreen').classList.remove('hidden');
    document.getElementById('errorMessage').textContent = error.message;
    return false;
  }
}

/* =======================================================
   Get JSON path from URL parameter or default
   ======================================================= */
function getContentPath() {
  const params = new URLSearchParams(window.location.search);

  // Check for uploaded file from localStorage
  const fromStorage = params.get('from_storage');
  if (fromStorage) {
    return `from_storage:${fromStorage}`;
  }

  // Check for regular content file
  const contentParam = params.get('content');
  if (contentParam) {
    // If path doesn't start with materials/, prepend it (for backward compatibility)
    if (!contentParam.startsWith('materials/') && !contentParam.startsWith('from_storage:')) {
      return `materials/${contentParam}`;
    }
    return contentParam;
  }

  // Default fallback
  return 'materials/ciencias-u1-content.json';
}

/* =======================================================
   Persistência e utilitários
   ======================================================= */
const now = () => new Date();
const todayStr = () => new Date().toISOString().slice(0,10);
const addDays = (d,n)=>{const t=new Date(d); t.setDate(t.getDate()+n); return t.toISOString().slice(0,10);};
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));

function getStorageKey(suffix) {
  return `${CONTENT_KEY}_${suffix}`;
}

function loadProgress(){ 
  try{ 
    return JSON.parse(localStorage.getItem(getStorageKey('progress'))||"{}"); 
  }catch(e){ 
    return {}; 
  } 
}

function saveProgress(p){ 
  localStorage.setItem(getStorageKey('progress'), JSON.stringify(p)); 
}

function loadStats(){ 
  try{ 
    return JSON.parse(localStorage.getItem(getStorageKey('stats'))||JSON.stringify({timeSec:0,streak:0,lastDay:null,quiz:[]})); 
  }catch(e){ 
    return {timeSec:0,streak:0,lastDay:null,quiz:[]}; 
  } 
}

function saveStats(s){ 
  localStorage.setItem(getStorageKey('stats'), JSON.stringify(s)); 
}

let PROG = {};
let STATS = {};

/* =======================================================
   Kid-Friendly Enhancements
   ======================================================= */

// Sound Effects System (using Web Audio API for beeps)
let audioContext;
let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playSound(type) {
  if (!soundEnabled) return;
  initAudio();

  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);

  if (type === 'correct') {
    // Happy ascending tones
    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.3);
  } else if (type === 'wrong') {
    // Gentle descending tone
    oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G4
    oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime + 0.15); // F4
    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.3);
  } else if (type === 'click') {
    // Short click sound
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.05);
  }
}

// Theme Toggle
function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');

  if (currentTheme === 'kids') {
    body.removeAttribute('data-theme');
    localStorage.setItem('theme', 'default');
  } else {
    body.setAttribute('data-theme', 'kids');
    localStorage.setItem('theme', 'kids');
  }
  playSound('click');
}

// Sound Toggle
function toggleSound() {
  soundEnabled = !soundEnabled;
  localStorage.setItem('soundEnabled', soundEnabled);

  const btn = document.getElementById('soundToggle');
  btn.textContent = soundEnabled ? '🔊' : '🔇';
  btn.classList.toggle('muted', !soundEnabled);

  if (soundEnabled) {
    playSound('click');
  }
}

// Confetti Celebration
function celebrate() {
  if (typeof confetti !== 'undefined') {
    confetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 },
      colors: ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6']
    });
  }
}

// Emoji Reactions
function showEmojiReaction(emoji, x, y) {
  const emojiEl = document.createElement('div');
  emojiEl.className = 'emoji-reaction';
  emojiEl.textContent = emoji;
  emojiEl.style.left = x + 'px';
  emojiEl.style.top = y + 'px';
  document.body.appendChild(emojiEl);

  setTimeout(() => {
    emojiEl.remove();
  }, 1500);
}

function randomEmoji(type) {
  const correctEmojis = ['🎉', '⭐', '🌟', '💯', '🎊', '✨', '🏆', '👏'];
  const wrongEmojis = ['💭', '🤔', '📚', '💪'];

  const list = type === 'correct' ? correctEmojis : wrongEmojis;
  return list[Math.floor(Math.random() * list.length)];
}

// Initialize theme and sound on load
function initKidsFriendly() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'kids') {
    document.body.setAttribute('data-theme', 'kids');
  }

  const soundBtn = document.getElementById('soundToggle');
  soundBtn.textContent = soundEnabled ? '🔊' : '🔇';
  soundBtn.classList.toggle('muted', !soundEnabled);

  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  document.getElementById('soundToggle').addEventListener('click', toggleSound);
}

/* =======================================================
   UI (temas, listas, impressão)
   ======================================================= */
function initializeQuiz() {
  // Load progress
  PROG = loadProgress();
  STATS = loadStats();
  
  // Extract unique themes from cards
  const temas = ["Todos", ...Array.from(new Set(CARDS.map(c => c.tema)))];
  
  const temaSelect = document.getElementById('temaSelect');
  const quizTema = document.getElementById('quizTema');
  
  temaSelect.innerHTML = "";
  quizTema.innerHTML = "";
  
  temas.forEach(t=>{
    const o=document.createElement('option'); 
    o.value=t; 
    o.textContent=t; 
    temaSelect.appendChild(o); 
    quizTema.appendChild(o.cloneNode(true));
  });

  buildTemaList();
  
  // Initialize UI
  updateDashboard();
  renderQuizHistory();
  
  // Set up event listeners
  setupEventListeners();
  
  // Show the flash tab
  switchTab("flash");
}

const temaList = document.getElementById('temaList');
function buildTemaList(){
  temaList.innerHTML="";
  const temas = Array.from(new Set(CARDS.map(c => c.tema)));
  const byTema = Object.fromEntries(temas.map(t=>[t, CARDS.filter(c=>c.tema===t)]));
  
  Object.entries(byTema).forEach(([t, cards])=>{
    const dom = cards.filter(c=> (PROG[c.id]?.box||0)>=3).length;
    const vistos = cards.filter(c=> PROG[c.id]).length;
    const pct = cards.length? Math.round(dom/cards.length*100) : 0;
    const div = document.createElement('div'); div.className="item";
    div.innerHTML = `<div><div><strong>${t}</strong> <span class="tag">${cards.length} cartões</span></div>
      <div class="progress" style="margin-top:.3rem;width:260px"><div class="bar" style="width:${pct}%"></div></div>
      <div class="small muted">${dom} dominados • ${vistos} vistos</div></div>
      <button class="btn" data-gotema="${t}">Estudar</button>`;
    temaList.appendChild(div);
  });
  temaList.querySelectorAll('button[data-gotema]').forEach(b=> b.onclick=()=>{ 
    document.getElementById('temaSelect').value=b.dataset.gotema; 
    pickNextCard(); 
    switchTab('flash'); 
  });
}

/* =======================================================
   Cartões: lógica (Leitner 1/3/7 dias)
   ======================================================= */
const dueCountEl=document.getElementById('dueCount');
const masteryPctEl=document.getElementById('masteryPct');
const globalBar=document.getElementById('globalBar');
const sessStatsEl=document.getElementById('sessStats');
let sessRight=0, sessTotal=0;
let sessionStart=Date.now();
const timerEl=document.getElementById('timer');
function tickTimer(){ 
  const sec=Math.floor((Date.now()-sessionStart)/1000); 
  timerEl.textContent=new Date(sec*1000).toISOString().slice(14,19); 
}
setInterval(tickTimer,1000);

function cardState(id){ 
  return PROG[id] || {box:0, seen:0, right:0, wrong:0, next:todayStr(), last:null}; 
}

function schedule(id, correct){
  const s = cardState(id); 
  s.seen++; 
  s.last=todayStr();
  if(correct){ 
    s.right++; 
    s.box=clamp(s.box+1,1,3); 
  } else { 
    s.wrong++; 
    s.box=1; 
  }
  const interval = s.box===1?1:(s.box===2?3:7);
  s.next = correct? addDays(todayStr(), interval) : todayStr();
  PROG[id]=s; 
  saveProgress(PROG);
  sessTotal++; 
  if(correct) sessRight++;
  updateDashboard();
  
  // streak: conta dia em que faz ≥10 cartões
  const day=todayStr();
  if(sessTotal>=10){
    if(STATS.lastDay!==day){ 
      STATS.streak=(STATS.lastDay===addDays(day,-1))? (STATS.streak||0)+1 : 1; 
      STATS.lastDay=day; 
      saveStats(STATS); 
    }
  }
}

function dueCards(filterTema){
  const day=todayStr();
  return CARDS.filter(c=>{
    const s=cardState(c.id);
    const temaOK=(filterTema==="Todos" || c.tema===filterTema);
    return temaOK && (!s.seen || s.next<=day);
  });
}

function updateDashboard(){
  const total=CARDS.length;
  const dom=CARDS.filter(c=> (cardState(c.id).box)>=3).length;
  const vistos=CARDS.filter(c=> cardState(c.id).seen>0).length;
  const temaSelect = document.getElementById('temaSelect');
  const dueToday=dueCards(temaSelect.value).length;
  const pct=Math.round(dom/total*100);
  
  masteryPctEl.textContent=pct+"%"; 
  globalBar.style.width=pct+"%"; 
  dueCountEl.textContent=dueToday; 
  sessStatsEl.textContent=`${sessRight}/${sessTotal}`;
  
  document.getElementById('pTotal').textContent=total;
  document.getElementById('pVistos').textContent=vistos;
  document.getElementById('pDom').textContent=dom;
  document.getElementById('pDueToday').textContent=dueCards("Todos").length;
  
  const elapsed=Math.floor((Date.now()-sessionStart)/1000); 
  const prev=STATS.timeSec||0;
  document.getElementById('pTime').textContent=Math.floor((prev+elapsed)/60)+" min";
  document.getElementById('pStreak').textContent=(STATS.streak||0)+" 🔥";
  
  // calendário de revisões
  const cal=document.getElementById('calendar');
  const counts={};
  CARDS.forEach(c=>{ 
    const s=cardState(c.id); 
    counts[s.next]=(counts[s.next]||0)+1; 
  });
  cal.innerHTML="";
  for(let i=0;i<14;i++){
    const d=addDays(todayStr(),i); 
    const n=counts[d]||0; 
    const barw=clamp(n*4,0,100);
    const div=document.createElement('div'); 
    div.className="item";
    div.innerHTML=`<span>${d}</span><div class="progress" style="width:200px"><div class="bar" style="width:${barw}%"></div></div><strong>${n}</strong>`;
    cal.appendChild(div);
  }
}

const fcQ=document.getElementById('fcQ');
const fcA=document.getElementById('fcA');
const fcMeta=document.getElementById('fcMeta');
let currentCard=null;
let flashAnswered=false;

function renderCard(c){
  currentCard=c; 
  fcQ.textContent=c.q; 
  fcA.textContent=c.a; 
  fcA.classList.add('hidden');
  document.getElementById('revealBtn').disabled=false;
  document.getElementById('rightBtn').disabled=true;
  document.getElementById('wrongBtn').disabled=true;
  flashAnswered=false;
  const s=cardState(c.id);
  fcMeta.innerHTML=`<span class="tag">${c.tema}</span> <span class="tag">Caixa ${Math.max(1,s.box||1)}</span> <span class="tag">Vistos: ${s.seen||0}</span>`;
}

function pickNextCard(){
  const temaSelect = document.getElementById('temaSelect');
  const filterTema=temaSelect.value;
  const pool=dueCards(filterTema);
  if(pool.length>0){ 
    renderCard(pool[Math.floor(Math.random()*pool.length)]); 
    return; 
  }
  const alt=CARDS.filter(c=> (filterTema==="Todos" || c.tema===filterTema))
                 .sort((a,b)=> (cardState(a.id).box||0)-(cardState(b.id).box||0));
  if(alt.length > 0) {
    renderCard(alt[0]);
  }
}

/* =======================================================
   Teste Rápido — distratores plausíveis e níveis
   ======================================================= */
const quizBox=document.getElementById('quizBox');
const startQuizBtn=document.getElementById('startQuiz');
const quizScoreEl=document.getElementById('quizScore');
const quizHistory=document.getElementById('quizHistory');
const quizLvlSel=document.getElementById('quizLvl');

function normalizeEnd(s){
  s = s.trim();
  if(/[.;]$/.test(s)) return s;
  return s + ".";
}

function similarLengthFilter(cands, targetLen, tol=0.35){
  return cands.filter(t=> Math.abs(t.length - targetLen)/Math.max(1,targetLen) <= tol);
}

function unique(arr){ 
  return Array.from(new Set(arr)); 
}

function handcraftedDistractors(card){
  const list = DIST[card.id.toString()] || [];
  return list.map(normalizeEnd);
}

function sample(arr, k){
  const a=arr.slice(); 
  const out=[];
  while(a.length && out.length<k){
    const i=Math.floor(Math.random()*a.length);
    out.push(a.splice(i,1)[0]);
  }
  return out;
}

function smartThemeDistractors(correctCard, tema, targetLen){
  const pool = CARDS.filter(c=> c.id!==correctCard.id && (!tema || c.tema===tema));
  let texts = pool.map(c=> c.a).filter(x=> x && x.length>2 && x!==correctCard.a);
  texts = texts.map(normalizeEnd);
  let out = similarLengthFilter(texts, targetLen, 0.35);
  if(out.length<6) out = texts;
  return unique(out);
}

function buildDistractors(card, tema, level){
  const targetLen = card.a.length;
  let ds = [];
  
  // 1) Feitos à mão
  ds = handcraftedDistractors(card);
  
  // 2) Adaptação ao nível
  if(level==="facil"){
    if(ds.length<3){
      const extras = smartThemeDistractors(card, (tema==="Todos"?null:tema), targetLen);
      ds = unique(ds.concat(extras));
    }
  } else if(level==="medio"){
    if(ds.length<3){
      const extras = smartThemeDistractors(card, (tema==="Todos"?null:tema), targetLen);
      const near = similarLengthFilter(extras, targetLen, 0.25);
      ds = unique(ds.concat(near));
    }
  } else { // difícil
    const extras = smartThemeDistractors(card, (tema==="Todos"?null:tema), targetLen);
    const near = similarLengthFilter(extras, targetLen, 0.18);
    ds = unique(ds.concat(near));
  }
  
  ds = ds.filter(x=> x !== card.a);
  
  if(ds.length<3){
    const extras = smartThemeDistractors(card, null, targetLen);
    ds = unique(ds.concat(extras)).filter(x=> x!==card.a);
  }
  
  return sample(ds, 3);
}

function renderQuizHistory(){
  quizHistory.innerHTML="";
  (STATS.quiz||[]).forEach(r=>{
    const d=new Date(r.date).toLocaleString();
    const row=document.createElement('div'); 
    row.className="item";
    row.innerHTML=`<span>${d} • <span class="muted">${r.tema}</span></span> <strong>${r.score}/${r.n} (${r.acc}%)</strong>`;
    quizHistory.appendChild(row);
  });
}

function buildQuiz(n, tema, level){
  const pool=CARDS.filter(c=> tema==="Todos"? true : c.tema===tema);
  const chosen=[]; 
  const used=new Set();
  
  while(chosen.length<n && used.size<pool.length){
    const i=Math.floor(Math.random()*pool.length); 
    if(used.has(i)) continue; 
    used.add(i); 
    chosen.push(pool[i]);
  }
  
  let score=0, index=0; 
  quizBox.innerHTML="";
  
  function renderQ(){
    const c=chosen[index];
    const ds=buildDistractors(c, tema, level);
    const opts=[...ds, normalizeEnd(c.a)].sort(()=>Math.random()-0.5);

    const div=document.createElement('div');
    div.className="panel"; 
    div.style.marginBottom=".8rem";
    div.innerHTML=`<div class="small muted"><span class="tag">${c.tema}</span> Pergunta ${index+1} de ${chosen.length}</div>
                   <div style="font-size:1.05rem;margin:.4rem 0 .6rem">${c.q}</div>`;

    const exp = document.createElement('div');
    exp.className = "small muted";
    exp.style.marginTop = ".4rem";

    opts.forEach((txt)=>{
      const b=document.createElement('button');
      b.className="btn";
      b.style.display="block"; 
      b.style.width="100%"; 
      b.style.textAlign="left"; 
      b.style.marginBottom=".4rem";
      b.textContent=txt;
      b.onclick=(e)=>{
        Array.from(div.querySelectorAll('button')).forEach(x=>x.disabled=true);
        const correct = (txt===normalizeEnd(c.a));
        if(correct){
          b.classList.add('good');
          score++;
          exp.innerHTML = "✅ Correto — " + normalizeEnd(c.a);

          // Celebration effects
          playSound('correct');
          celebrate();
          const rect = e.target.getBoundingClientRect();
          showEmojiReaction(randomEmoji('correct'), rect.left + rect.width / 2, rect.top);
          b.classList.add('pulse');
        }
        else{
          b.classList.add('bad');
          exp.innerHTML = "❌ Incorrecto — Resposta certa: " + normalizeEnd(c.a);

          // Wrong answer effects
          playSound('wrong');
          const rect = e.target.getBoundingClientRect();
          showEmojiReaction(randomEmoji('wrong'), rect.left + rect.width / 2, rect.top);
          b.classList.add('shake');
        }
        quizScoreEl.textContent=score;
        div.appendChild(exp);

        if(index<chosen.length-1){
          setTimeout(()=>{ index++; renderQ(); }, 600);
        } else {
          const acc=Math.round(score/chosen.length*100);
          const res=document.createElement('div'); 
          res.className="item"; 
          res.innerHTML=`<span>Resultado final</span> <strong>${score}/${chosen.length} (${acc}%)</strong>`;
          quizBox.appendChild(res);
          STATS.quiz=STATS.quiz||[]; 
          STATS.quiz.unshift({date:new Date().toISOString(), tema, n:chosen.length, score, acc}); 
          STATS.quiz=STATS.quiz.slice(0,10); 
          saveStats(STATS); 
          renderQuizHistory();
        }
      };
      div.appendChild(b);
    });
    quizBox.appendChild(div);
  }
  renderQ();
}

/* =======================================================
   Verdadeiro/Falso
   ======================================================= */
let vfSess=0; 
const vfSessEl=document.getElementById('vfSess');
let vfAnswered=false;

function newVF(){
  const i=Math.floor(Math.random()*VF.length); 
  const v=VF[i];
  document.getElementById('vfText').textContent=v.t; 
  document.getElementById('vfText').dataset.idx=i;
  document.getElementById('vfExp').classList.add('hidden'); 
  document.getElementById('vfMeta').textContent="Marque a opção correta e veja a explicação.";
  vfAnswered=false;
  document.getElementById('vfV').disabled=false;
  document.getElementById('vfF').disabled=false;
}

function answerVF(ans){
  if(vfAnswered) return;
  const idx=+document.getElementById('vfText').dataset.idx;
  if(isNaN(idx)) return;
  const v=VF[idx];
  const ok=(ans===v.v);
  const exp=document.getElementById('vfExp');
  exp.textContent=(ok?"✅ Correto. ":"❌ Incorrecto. ")+(v.e||"");
  exp.classList.remove('hidden');

  const flashcard = document.querySelector('#vf .flashcard');

  if(ok){
    vfSess++;
    vfSessEl.textContent=vfSess;

    // Celebration effects
    playSound('correct');
    celebrate();
    showEmojiReaction(randomEmoji('correct'), window.innerWidth / 2, window.innerHeight / 2);
    flashcard.classList.add('celebrate');
    setTimeout(() => flashcard.classList.remove('celebrate'), 600);
  } else {
    // Wrong answer effects
    playSound('wrong');
    showEmojiReaction(randomEmoji('wrong'), window.innerWidth / 2, window.innerHeight / 2);
    flashcard.classList.add('shake');
    setTimeout(() => flashcard.classList.remove('shake'), 500);
  }

  vfAnswered=true;
  document.getElementById('vfV').disabled=true;
  document.getElementById('vfF').disabled=true;
}

/* =======================================================
   Event Listeners Setup
   ======================================================= */
function setupEventListeners() {
  const temaSelect = document.getElementById('temaSelect');
  
  // Flashcards
  document.getElementById('revealBtn').onclick=()=>{ 
    fcA.classList.remove('hidden'); 
    document.getElementById('rightBtn').disabled=false; 
    document.getElementById('wrongBtn').disabled=false; 
    document.getElementById('revealBtn').disabled=true; 
  };
  
  document.getElementById('rightBtn').onclick=(e)=>{
    if(!currentCard || flashAnswered) return;
    flashAnswered=true;

    // Celebration effects
    playSound('correct');
    celebrate();

    const emoji = randomEmoji('correct');
    const rect = e.target.getBoundingClientRect();
    showEmojiReaction(emoji, rect.left + rect.width / 2, rect.top);

    const flashcard = document.querySelector('.flashcard');
    flashcard.classList.add('celebrate');
    setTimeout(() => flashcard.classList.remove('celebrate'), 600);

    schedule(currentCard.id,true);
    setTimeout(() => pickNextCard(), 400);
  };

  document.getElementById('wrongBtn').onclick=(e)=>{
    if(!currentCard || flashAnswered) return;
    flashAnswered=true;

    // Wrong answer effects
    playSound('wrong');

    const emoji = randomEmoji('wrong');
    const rect = e.target.getBoundingClientRect();
    showEmojiReaction(emoji, rect.left + rect.width / 2, rect.top);

    const flashcard = document.querySelector('.flashcard');
    flashcard.classList.add('shake');
    setTimeout(() => flashcard.classList.remove('shake'), 500);

    schedule(currentCard.id,false);
    setTimeout(() => pickNextCard(), 400);
  };
  
  document.getElementById('nextBtn').onclick=pickNextCard;
  temaSelect.onchange=()=>{ updateDashboard(); pickNextCard(); };

  // Quiz
  startQuizBtn.onclick=()=>{
    const n=clamp(parseInt(document.getElementById('quizN').value||"10",10),5,25);
    const tema=document.getElementById('quizTema').value;
    const level = quizLvlSel.value;
    quizScoreEl.textContent="0";
    buildQuiz(n, tema, level);
  };

  // True/False
  document.getElementById('vfNew').onclick=newVF;
  document.getElementById('vfV').onclick=()=>answerVF(true);
  document.getElementById('vfF').onclick=()=>answerVF(false);

  // Export/Import/Reset
  document.getElementById('exportBtn').onclick=()=>{
    const payload={progress:PROG, stats:STATS, exportedAt:new Date().toISOString(), contentKey:CONTENT_KEY};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); 
    a.href=url; 
    a.download=`progresso_${CONTENT_KEY}.json`; 
    a.click(); 
    URL.revokeObjectURL(url);
  };
  
  document.getElementById('importFile').onchange=(ev)=>{
    const file=ev.target.files[0]; 
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const data=JSON.parse(reader.result);
        if(data.progress){ PROG=data.progress; saveProgress(PROG); }
        if(data.stats){ STATS=data.stats; saveStats(STATS); }
        alert("Importação concluída!");
        updateDashboard(); 
        buildTemaList(); 
        pickNextCard();
      }catch(e){ 
        alert("Ficheiro inválido."); 
      }
    };
    reader.readAsText(file);
  };
  
  document.getElementById('resetBtn').onclick=()=>{
    if(confirm("Apagar TODO o progresso?")){ 
      localStorage.removeItem(getStorageKey('progress')); 
      localStorage.removeItem(getStorageKey('stats'));
      PROG={}; 
      STATS={timeSec:0,streak:0,lastDay:null,quiz:[]}; 
      updateDashboard(); 
      buildTemaList(); 
      alert("Progresso reposto."); 
    }
  };

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if (currentTab === "flash") {
      if (e.code === "Space") { 
        e.preventDefault(); 
        document.getElementById('revealBtn').click(); 
      }
      if (e.key.toLowerCase() === 'a' && !flashAnswered) { 
        document.getElementById('rightBtn').click(); 
      }
      if (e.key.toLowerCase() === 'e' && !flashAnswered) { 
        document.getElementById('wrongBtn').click(); 
      }
    } else if (currentTab === "vf") {
      const key = e.key.toLowerCase();
      if (key === "v" && !vfAnswered) { 
        document.getElementById("vfV").click(); 
      }
      else if (key === "f" && !vfAnswered) { 
        document.getElementById("vfF").click(); 
      }
      else if (e.code === "Space") { 
        e.preventDefault(); 
        document.getElementById("vfNew").click(); 
      }
    }
  });

  // Save time on exit
  window.addEventListener('beforeunload', ()=>{
    const elapsed=Math.floor((Date.now()-sessionStart)/1000);
    STATS.timeSec=(STATS.timeSec||0)+elapsed; 
    saveStats(STATS);
  });
}

/* =======================================================
   Tabs
   ======================================================= */
let currentTab="flash";

function switchTab(id){
  document.querySelectorAll('.tab').forEach(el=>el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
  currentTab=id;
  if(id==="flash"){ pickNextCard(); }
  if(id==="painel"){ updateDashboard(); }
}

document.querySelectorAll('.tabbtn').forEach(b=> b.onclick=()=> switchTab(b.dataset.tab));

/* =======================================================
   Initialize on page load
   ======================================================= */
window.addEventListener('DOMContentLoaded', () => {
  initKidsFriendly();
  const contentPath = getContentPath();
  loadContent(contentPath);
});
</script>
</body>
</html>


