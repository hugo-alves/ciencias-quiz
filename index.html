<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz de Estudo - Sele√ß√£o de Conte√∫do</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#94a3b8;
    --accent:#22c55e; --border:#1f2937; --btn:#1e293b; --btn-hover:#243447;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f8fafc; --card:#ffffff; --fg:#0f172a; --muted:#475569; --border:#e2e8f0; --btn:#e2e8f0; --btn-hover:#cbd5e1; }
  }
  /* Kid-Friendly Theme */
  body[data-theme="kids"]{
    --bg:#fff8f0; --card:#ffffff; --fg:#2c3e50; --muted:#7f8c8d;
    --accent:#27ae60; --border:#e8dacc; --btn:#ecf0f1; --btn-hover:#dfe6e9;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font:18px/1.6 'Nunito',system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:1rem;
    transition:background 0.3s, color 0.3s;
  }
  .container{
    max-width:800px;
    width:100%;
  }
  .header{
    text-align:center;
    margin-bottom:2rem;
  }
  h1{
    font-size:2.5rem;
    margin:0 0 0.5rem;
    background:linear-gradient(135deg,#06b6d4,#22c55e);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .subtitle{
    color:var(--muted);
    font-size:1.1rem;
  }
  .section{
    margin-bottom:2.5rem;
  }
  .section-title{
    font-size:1.4rem;
    margin:0 0 1rem;
    color:var(--accent);
    letter-spacing:0.02em;
  }
  .content-list{
    display:flex;
    flex-direction:column;
    gap:1rem;
  }
  .content-card{
    background:var(--card);
    border:2px solid var(--border);
    border-radius:1.2rem;
    padding:1.8rem;
    cursor:pointer;
    transition:all 0.3s;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:1rem;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  .content-card:hover{
    transform:translateY(-4px) scale(1.01);
    box-shadow:0 12px 24px rgba(0,0,0,0.3);
    border-color:var(--accent);
  }
  .content-info h2{
    margin:0 0 0.3rem;
    font-size:1.3rem;
  }
  .content-info p{
    margin:0;
    color:var(--muted);
    font-size:0.95rem;
  }
  .badge{
    background:var(--btn);
    padding:0.3rem 0.7rem;
    border-radius:0.5rem;
    font-size:0.85rem;
    color:var(--muted);
    border:1px solid var(--border);
  }
  .custom-section{
    margin-top:2rem;
    padding:1.5rem;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:1rem;
  }
  .custom-section h3{
    margin:0 0 1rem;
    font-size:1.2rem;
  }
  .input-group{
    display:flex;
    gap:0.5rem;
    margin-bottom:0.8rem;
  }
  input[type="text"]{
    flex:1;
    background:var(--bg);
    color:var(--fg);
    border:1px solid var(--border);
    padding:0.7rem;
    border-radius:0.5rem;
    font-size:1rem;
  }
  button{
    background:linear-gradient(135deg,#2563eb,#06b6d4);
    color:white;
    border:none;
    padding:0.9rem 1.8rem;
    border-radius:1rem;
    cursor:pointer;
    font-size:1.05rem;
    font-weight:600;
    transition:transform 0.2s, box-shadow 0.2s;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
  }
  button:hover{
    transform:translateY(-2px) scale(1.02);
    box-shadow:0 6px 16px rgba(0,0,0,0.25);
  }
  button:active{
    transform:translateY(0) scale(0.98);
  }
  .small{
    font-size:0.9rem;
    color:var(--muted);
    margin-top:0.5rem;
  }
  .arrow{
    font-size:1.5rem;
    color:var(--accent);
  }
  @media (max-width: 600px){
    h1{ font-size:1.8rem; }
    .content-card{ flex-direction:column; align-items:flex-start; }
    .arrow{ display:none; }
  }

  /* Theme toggle button */
  .theme-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .theme-toggle:hover {
    transform: scale(1.1) rotate(10deg);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìö Quiz de Estudo</h1>
    <p class="subtitle">Selecione o conte√∫do que deseja estudar</p>
  </div>

  <!-- Quiz content will be dynamically loaded here -->
  <div id="quizContainer">
    <div style="text-align: center; padding: 2rem; color: var(--muted);">
      <p>‚è≥ A carregar conte√∫dos dispon√≠veis...</p>
    </div>
  </div>

  <div class="custom-section">
    <h3>üîß Carregar Ficheiro Personalizado</h3>
    
    <!-- File Upload -->
    <div style="margin-bottom: 1rem;">
      <input 
        type="file" 
        id="fileUpload" 
        accept=".json"
        style="display: none;"
      />
      <button onclick="document.getElementById('fileUpload').click()" style="width: 100%; margin-bottom: 0.5rem;">
        üìÅ Upload JSON File
      </button>
      <div id="uploadStatus" class="small" style="min-height: 1.5rem;"></div>
    </div>
    
    <!-- Text Input for Existing Files -->
    <div class="input-group">
      <input 
        type="text" 
        id="customPath" 
        placeholder="ou digite nome do ficheiro (ex: meu-conteudo.json)"
        value=""
      />
      <button onclick="loadCustomQuiz()">Carregar</button>
    </div>
    <div class="small">
      Escolha um ficheiro JSON do seu computador ou digite o nome de um ficheiro j√° no servidor.
      <br>Para criar novo conte√∫do, consulte o <code>README.md</code>.
    </div>
  </div>

  <div style="text-align:center; margin-top:2rem; color:var(--muted); font-size:0.9rem;">
    Sistema gen√©rico de quiz ‚Ä¢ Basta criar um JSON para adicionar novo conte√∫do
    <br>
    <a href="README.md" style="color:var(--accent); text-decoration:none;">üìñ Ver documenta√ß√£o</a>
  </div>
</div>

<!-- Theme Toggle Button -->
<button class="theme-toggle" id="themeToggle" title="Alternar tema para crian√ßas" aria-label="Alternar tema">üé®</button>

<script>
function loadQuiz(contentFile) {
  window.location.href = `quiz-template.html?content=materials/${encodeURIComponent(contentFile)}`;
}

// Dynamically load all quizzes from materials folder
async function loadAvailableQuizzes() {
  const container = document.getElementById('quizContainer');

  try {
    // Load the index of available files
    const indexResponse = await fetch('materials/index.json');
    if (!indexResponse.ok) throw new Error('Could not load quiz index');
    const quizFiles = await indexResponse.json();

    // Fetch metadata for all quizzes
    const quizData = await Promise.all(
      quizFiles.map(async (filename) => {
        try {
          const response = await fetch(`materials/${filename}`);
          if (!response.ok) return null;
          const data = await response.json();
          return {
            filename,
            metadata: data.metadata,
            cardCount: data.cards ? data.cards.length : 0,
            trueFalseCount: data.trueFalse ? data.trueFalse.length : 0
          };
        } catch (error) {
          console.error(`Error loading ${filename}:`, error);
          return null;
        }
      })
    );

    // Filter out failed loads
    const validQuizzes = quizData.filter(q => q !== null);

    if (validQuizzes.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--muted);"><p>Nenhum conte√∫do dispon√≠vel</p></div>';
      return;
    }

    // Group quizzes by subject (extracted from metadata or inferred from title)
    const grouped = groupQuizzesBySubject(validQuizzes);

    // Render grouped quizzes
    container.innerHTML = '';
    for (const [subject, quizzes] of Object.entries(grouped)) {
      const section = createSection(subject, quizzes);
      container.appendChild(section);
    }

  } catch (error) {
    console.error('Error loading quizzes:', error);
    container.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--muted);">
        <p>‚ö†Ô∏è Erro ao carregar conte√∫dos</p>
        <p style="font-size: 0.9rem;">${error.message}</p>
      </div>
    `;
  }
}

function groupQuizzesBySubject(quizzes) {
  const groups = {};

  for (const quiz of quizzes) {
    let subject = 'Outros Conte√∫dos';
    const title = quiz.metadata.title.toLowerCase();

    // Infer subject from title
    if (title.includes('portugu√™s')) {
      subject = 'Portugu√™s 5.¬∫ ano';
    } else if (title.includes('hgp') || title.includes('hist√≥ria e geografia')) {
      subject = 'Hist√≥ria e Geografia de Portugal 5.¬∫ ano';
    } else if (title.includes('ci√™ncias')) {
      subject = 'Ci√™ncias Naturais';
    } else if (title.includes('ingl√™s')) {
      subject = 'Ingl√™s';
    } else if (title.includes('hist√≥ria')) {
      subject = 'Hist√≥ria';
    }

    if (!groups[subject]) {
      groups[subject] = [];
    }
    groups[subject].push(quiz);
  }

  return groups;
}

function createSection(title, quizzes) {
  const section = document.createElement('div');
  section.className = 'section';

  const sectionTitle = document.createElement('h2');
  sectionTitle.className = 'section-title';
  sectionTitle.textContent = title;

  const contentList = document.createElement('div');
  contentList.className = 'content-list';

  for (const quiz of quizzes) {
    const card = createQuizCard(quiz);
    contentList.appendChild(card);
  }

  section.appendChild(sectionTitle);
  section.appendChild(contentList);

  return section;
}

function createQuizCard(quiz) {
  const card = document.createElement('div');
  card.className = 'content-card';
  card.onclick = () => loadQuiz(quiz.filename);

  // Extract badge/subject from title
  let badgeText = 'Quiz';
  const title = quiz.metadata.title.toLowerCase();
  if (title.includes('portugu√™s')) badgeText = 'Portugu√™s';
  else if (title.includes('hgp')) badgeText = 'HGP';
  else if (title.includes('ci√™ncias')) badgeText = 'Ci√™ncias';
  else if (title.includes('ingl√™s')) badgeText = 'Ingl√™s';
  else if (title.includes('hist√≥ria')) badgeText = 'Hist√≥ria';

  // Build description
  let description = quiz.metadata.subtitle || quiz.metadata.description || '';
  // Strip HTML tags for display
  description = description.replace(/<[^>]*>/g, '');
  // Add card count and version info
  const version = quiz.metadata.version ? ` ‚Ä¢ ${quiz.metadata.version}` : '';
  description += ` ‚Ä¢ ${quiz.cardCount} cart√µes${version}`;

  card.innerHTML = `
    <div class="content-info">
      <h2>${quiz.metadata.title}</h2>
      <p>${description}</p>
    </div>
    <div>
      <span class="badge">${badgeText}</span>
      <span class="arrow">‚Üí</span>
    </div>
  `;

  return card;
}

function loadCustomQuiz() {
  const path = document.getElementById('customPath').value.trim();
  if (!path) {
    alert('Por favor, insira o caminho do ficheiro JSON.');
    return;
  }
  if (!path.endsWith('.json')) {
    alert('O ficheiro deve ter extens√£o .json');
    return;
  }
  // For custom input, try materials folder first, then root
  window.location.href = `quiz-template.html?content=materials/${encodeURIComponent(path)}`;
}

// Theme toggle functionality
function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');

  if (currentTheme === 'kids') {
    body.removeAttribute('data-theme');
    localStorage.setItem('theme', 'default');
  } else {
    body.setAttribute('data-theme', 'kids');
    localStorage.setItem('theme', 'kids');
  }
}

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
  // Load available quizzes
  loadAvailableQuizzes();

  // Initialize theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'kids') {
    document.body.setAttribute('data-theme', 'kids');
  }

  // Setup theme toggle button
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // Setup file upload handler
  document.getElementById('fileUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const status = document.getElementById('uploadStatus');
    status.textContent = '‚è≥ A carregar...';

    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);

        // Validate JSON structure
        if (!data.metadata || !data.cards || !data.distractors || !data.trueFalse) {
          throw new Error('JSON inv√°lido: faltam campos obrigat√≥rios');
        }

        // Store in localStorage temporarily
        const timestamp = Date.now();
        const storageKey = `uploaded_quiz_${timestamp}`;
        localStorage.setItem(storageKey, event.target.result);

        status.innerHTML = `<span style="color: var(--accent);">‚úì File carregado!</span>`;

        // Show a button to load it
        setTimeout(() => {
          const loadBtn = document.createElement('button');
          loadBtn.textContent = '‚ñ∂Ô∏è Abrir Quiz Carregado';
          loadBtn.style.width = '100%';
          loadBtn.style.marginTop = '0.5rem';
          loadBtn.onclick = () => {
            // Pass the data to quiz-template via localStorage key
            window.location.href = `quiz-template.html?from_storage=${storageKey}`;
          };
          status.appendChild(loadBtn);
        }, 500);

      } catch (error) {
        status.innerHTML = `<span style="color: #ef4444;">‚úó Erro: ${error.message}</span>`;
      }
    };

    reader.onerror = function() {
      status.innerHTML = '<span style="color: #ef4444;">‚úó Erro ao ler ficheiro</span>';
    };

    reader.readAsText(file);
  });

  // Allow Enter key in custom path input
  document.getElementById('customPath').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      loadCustomQuiz();
    }
  });
});
</script>
</body>
</html>
